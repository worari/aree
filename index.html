<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบการปกครองและวินัยทหาร</title>

    <!-- Tailwind CSS, Google Fonts, SweetAlert2, Lucide Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-image: linear-gradient(to bottom right, #4c1d95, #a855f7, #facc15, #b45309);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 167, 0, 0.3);
            transition: all 0.3s ease;
        }
        .card:hover { box-shadow: 0 10px 20px rgba(0,0,0,0.2); transform: translateY(-4px); }
        .btn-primary { background-color: #6B21A8; color: white; transition: all 0.3s ease; font-weight: 500; }
        .btn-primary:hover { background-color: #D6A700; color: #4A044E; transform: scale(1.05); }
        .form-input { border-color: #e2e8f0; transition: all 0.2s ease; }
        .form-input:focus { border-color: #6B21A8; box-shadow: 0 0 0 2px rgba(107, 33, 168, 0.2); }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #6B21A8; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [data-role] { display: none; } /* Hide role-specific elements by default */
        @media print {
            body { background-image: none; background-color: white; }
            header, footer, #reportFormSection, .no-print, #auth-container { display: none; }
            main, #reviewListSection, .card { all: unset; display: block; }
            .card { page-break-inside: avoid; margin-bottom: 1rem; border: 1px solid #ccc; padding: 1rem; }
        }
    </style>
</head>
<body class="min-h-screen text-gray-800 flex items-center justify-center">

    <!-- Auth Container -->
    <div id="auth-container" class="w-full max-w-md">
        <!-- Login Form -->
        <div id="login-form-container" class="card rounded-2xl p-8 shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center text-purple-900">เข้าสู่ระบบ</h2>
            <form id="loginForm" class="space-y-4">
                <input type="text" id="loginUsername" placeholder="ชื่อผู้ใช้" class="form-input w-full p-3 border rounded-lg" required>
                <input type="password" id="loginPassword" placeholder="รหัสผ่าน" class="form-input w-full p-3 border rounded-lg" required>
                <button type="submit" class="btn-primary w-full py-3 rounded-xl text-lg">เข้าสู่ระบบ</button>
            </form>
            <p class="text-center mt-4 text-sm">ยังไม่มีบัญชี? <a href="#" id="show-register" class="text-purple-700 hover:underline">ลงทะเบียนที่นี่</a></p>
        </div>
        <!-- Register Form -->
        <div id="register-form-container" class="card rounded-2xl p-8 shadow-lg hidden">
            <h2 class="text-2xl font-bold mb-6 text-center text-purple-900">ลงทะเบียนผู้ใช้งาน</h2>
            <form id="registerForm" class="space-y-4">
                <input type="text" id="registerUsername" placeholder="ชื่อผู้ใช้" class="form-input w-full p-3 border rounded-lg" required>
                <input type="password" id="registerPassword" placeholder="รหัสผ่าน" class="form-input w-full p-3 border rounded-lg" required>
                <button type="submit" class="btn-primary w-full py-3 rounded-xl text-lg">ลงทะเบียน</button>
            </form>
            <p class="text-center mt-4 text-sm">มีบัญชีอยู่แล้ว? <a href="#" id="show-login" class="text-purple-700 hover:underline">เข้าสู่ระบบที่นี่</a></p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="w-full hidden">
        <div id="app" class="p-4 md:p-6">
            <header class="text-center py-6 flex justify-between items-center">
                <div></div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white shadow-lg">ระบบการปกครองและวินัยทหาร</h1>
                    <p class="text-yellow-200 mt-1">Military Discipline & Governance System</p>
                </div>
                <div class="text-right">
                    <p id="user-display" class="text-white text-sm"></p>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm mt-1">ออกจากระบบ</button>
                </div>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Section 1: Report Form -->
                <section id="reportFormSection" data-role="reporter admin" class="card rounded-2xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 flex items-center text-purple-900"><i data-lucide="file-pen-line" class="mr-2"></i>บันทึกการกระทำความผิด</h2>
                    <form id="disciplineForm" class="space-y-4">
                        <input type="hidden" id="caseId">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="rank" placeholder="ยศ" class="form-input w-full p-2 border rounded-lg" required>
                            <input type="text" id="firstName" placeholder="ชื่อ" class="form-input w-full p-2 border rounded-lg" required>
                            <input type="text" id="lastName" placeholder="นามสกุล" class="form-input w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="unit" placeholder="หน่วย/สังกัด" class="form-input w-full p-2 border rounded-lg" required>
                            <input type="text" id="position" placeholder="ตำแหน่ง" class="form-input w-full p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">วันที่เกิดเหตุ</label>
                            <input type="date" id="startDate" class="form-input w-full p-2 border rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ประเภทความผิด</label>
                            <select id="offenseType" class="form-input w-full p-2 border rounded-lg" required>
                                <option value="">-- เลือกประเภท --</option>
                                <option value="วินัย">วินัย</option>
                                <option value="ธรรมเนียม">ธรรมเนียม</option>
                                <option value="กฎหมาย">กฎหมาย</option>
                                <option value="อื่นๆ">อื่นๆ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ระยะเวลาการตรวจสอบ</label>
                            <div class="flex items-center gap-4">
                                <select id="reviewDuration" class="form-input flex-grow p-2 border rounded-lg" required>
                                    <option value="">-- เลือกระยะเวลา --</option>
                                    <option value="15">15 วัน</option>
                                    <option value="30">30 วัน</option>
                                    <option value="45">45 วัน</option>
                                    <option value="60">60 วัน</option>
                                    <option value="90">90 วัน</option>
                                    <option value="120">120 วัน</option>
                                    <option value="150">150 วัน</option>
                                </select>
                                <input type="text" id="dueDate" placeholder="วันที่กำหนดตรวจเสร็จ" class="form-input flex-grow p-2 border rounded-lg bg-gray-100" readonly>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">รายละเอียดความผิด</label>
                            <textarea id="details" rows="4" class="form-input w-full p-2 border rounded-lg" required></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">แนบไฟล์หลักฐาน (รูปภาพ)</label>
                            <input type="file" id="evidenceFiles" class="form-input w-full p-2 border rounded-lg" multiple accept="image/*">
                            <div id="file-preview-container" class="mt-2 flex flex-wrap gap-2"></div>
                        </div>
                        <div class="flex flex-wrap gap-2 pt-4">
                            <button type="submit" id="saveBtn" class="btn-primary px-4 py-2 rounded-xl flex items-center">
                                <i data-lucide="save" class="mr-2 h-5 w-5"></i><span id="saveBtnText">บันทึกความผิด</span>
                            </button>
                            <button type="button" id="clearBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-xl flex items-center transition">
                                <i data-lucide="delete" class="mr-2 h-5 w-5"></i>ล้างฟอร์ม
                            </button>
                        </div>
                    </form>
                </section>

                <!-- Section 2: Review List -->
                <section id="reviewListSection" class="card rounded-2xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 flex items-center text-purple-900"><i data-lucide="clipboard-list" class="mr-2"></i>รายการตรวจสอบรายงานความผิด</h2>
                    <div class="flex flex-wrap gap-2 mb-4 justify-between items-center no-print">
                        <div class="flex flex-wrap gap-2" id="filter-buttons">
                            <button data-filter="all" class="filter-btn bg-purple-200 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">ทั้งหมด</button>
                            <button data-filter="pending" class="filter-btn bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">กำลังดำเนินการ</button>
                            <button data-filter="reviewed" class="filter-btn bg-green-200 text-green-800 px-3 py-1 rounded-full text-sm font-medium">ตรวจสอบแล้ว</button>
                        </div>
                        <div class="flex gap-2">
                             <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg flex items-center" title="Export to Excel">
                                <i data-lucide="file-spreadsheet"></i>
                            </button>
                            <button id="printPdfBtn" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg flex items-center" title="พิมพ์รายงาน">
                                <i data-lucide="printer"></i>
                            </button>
                        </div>
                    </div>
                    <div id="reportList" class="space-y-4">
                        <div id="loading" class="flex justify-center items-center p-10"><div class="loader"></div></div>
                    </div>
                </section>
            </main>

            <footer class="text-center py-6 text-sm text-white/80">
                © 2025 สำนักปกครอง กพ.ทบ. | ออกแบบโดย ร.ท.วรดร อ.
            </footer>
        </div>
    </div>
    
    <!-- Modals (Image, Timeline) -->
    <div id="imageModal" class="fixed inset-0 bg-black/80 flex justify-center items-center p-4 z-50 hidden"><img id="modalImage" src="" class="max-w-full max-h-full object-contain"><button id="closeModal" class="absolute top-4 right-4 text-white text-4xl">&times;</button></div>
    <div id="timelineModal" class="fixed inset-0 bg-black/80 flex justify-center items-center p-4 z-50 hidden"><div class="bg-white p-6 rounded-lg max-w-lg w-full"><h3 class="text-xl font-bold mb-4">ไทม์ไลน์สถานะ</h3><div id="timelineContent" class="space-y-4"></div><button id="closeTimelineModal" class="mt-6 bg-gray-500 text-white px-4 py-2 rounded-lg">ปิด</button></div></div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
    $(document).ready(function() {
        // !!! สำคัญ: กรุณาใส่ URL ของ Web App ที่ได้จากการ Deploy ที่นี่ !!!
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyA8pedQhJTFRUydmsAsqaQnw3xAnzEfwUiXud0VytOkOlMB-Z4ztRolf7FFOdQNME/exec';
        
        let localReportsCache = [];
        let fileDataUrls = [];
        let currentUser = null;

        /**
         * UPDATED: Generic API call function with proper error handling.
         * This function now reads the response from Google Apps Script.
         */
        async function apiCall(action, data) {
            const payload = { action, data };
            try {
                const response = await fetch(SCRIPT_URL, {
                    redirect: "follow",
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || 'An unknown script error occurred.');
                }
                
                return result; // Return the successful result
            } catch (error) {
                console.error('API Call Failed:', error);
                // Re-throw the error to be caught by the calling function
                throw error;
            }
        }


        // --- AUTHENTICATION ---
        
        function checkLoginState() {
            const userJson = sessionStorage.getItem('currentUser');
            if (userJson) {
                currentUser = JSON.parse(userJson);
                $('#auth-container').hide();
                $('#app-container').show();
                $('body').removeClass('items-center justify-center');
                initializeApp(currentUser);
            } else {
                $('#auth-container').show();
                $('#app-container').hide();
                $('body').addClass('items-center justify-center');
            }
        }

        $('#loginForm').on('submit', async function(e) {
            e.preventDefault();
            const username = $('#loginUsername').val().trim(); // FIX: Trim whitespace
            const password = $('#loginPassword').val().trim(); // FIX: Trim whitespace
            
            if (!username || !password) {
                Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน', 'warning');
                return;
            }

            Swal.fire({ title: 'กำลังเข้าสู่ระบบ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            try {
                const result = await apiCall('LOGIN', { username, password });
                Swal.close();
                sessionStorage.setItem('currentUser', JSON.stringify(result.user));
                checkLoginState();
            } catch (error) {
                Swal.fire('เกิดข้อผิดพลาด', error.message, 'error');
            }
        });

        $('#registerForm').on('submit', async function(e) {
            e.preventDefault();
            const username = $('#registerUsername').val().trim(); // FIX: Trim whitespace
            const password = $('#registerPassword').val().trim(); // FIX: Trim whitespace

            if (!username || !password) {
                Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน', 'warning');
                return;
            }

            Swal.fire({ title: 'กำลังลงทะเบียน...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const result = await apiCall('REGISTER', { username, password });
                Swal.fire('สำเร็จ!', result.message, 'success');
                $('#show-login').click();
            } catch(error) {
                 Swal.fire('เกิดข้อผิดพลาด', error.message, 'error');
            }
        });
        
        $('#logoutBtn').on('click', function() {
            sessionStorage.removeItem('currentUser');
            currentUser = null;
            location.reload();
        });

        $('#show-register').on('click', (e) => { e.preventDefault(); $('#login-form-container').hide(); $('#register-form-container').show(); });
        $('#show-login').on('click', (e) => { e.preventDefault(); $('#register-form-container').hide(); $('#login-form-container').show(); });

        // --- APP INITIALIZATION ---
        
        function initializeApp(user) {
            $('#user-display').text(`ผู้ใช้: ${user.username} (สิทธิ์: ${user.role})`);
            applyRolePermissions(user.role);
            fetchReports();
            lucide.createIcons();
        }

        function applyRolePermissions(role) {
            $(`[data-role]`).each(function() {
                const requiredRoles = $(this).data('role').split(' ');
                if(requiredRoles.includes(role)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }

        // --- CORE APP LOGIC ---

        async function fetchReports() {
            if (!SCRIPT_URL || SCRIPT_URL.includes('YOUR_WEB_APP_URL')) {
                $('#reportList').html('<p class="text-center text-red-600 p-4 bg-red-100 rounded-lg">กรุณาตั้งค่า SCRIPT_URL ในไฟล์ HTML ก่อน</p>');
                return;
            }
            $('#loading').show();
            $('#reportList').empty();
            try {
                // GET request to fetch data
                const response = await fetch(SCRIPT_URL);
                const result = await response.json();
                $('#loading').hide();

                if (result.success) {
                    localReportsCache = result.data;
                    renderReports($('#filter-buttons .bg-purple-800').data('filter') || 'all');
                } else { 
                    throw new Error(result.message); 
                }
            } catch (error) {
                $('#loading').hide();
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถดึงข้อมูลได้: ' + error.message, 'error');
                $('#reportList').html(`<p class="text-center text-gray-500">ไม่สามารถโหลดข้อมูลได้: ${error.message}</p>`);
            }
        }
        
        function renderReports(filter = 'all') {
            $('#reportList').empty();
            const filteredReports = localReportsCache.filter(report => {
                if (filter === 'all') return true;
                const reviewedStatus = (String(report.reviewed).toLowerCase() === 'true');
                if (filter === 'pending') return !reviewedStatus;
                if (filter === 'reviewed') return reviewedStatus;
            });

            if (filteredReports.length === 0) {
                 $('#reportList').html('<p class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">ยังไม่มีรายการความผิด</p>');
                 return;
            }
            
             filteredReports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            filteredReports.forEach(report => {
                const isReviewed = String(report.reviewed).toLowerCase() === 'true';
                const statusClass = isReviewed ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const statusText = isReviewed ? 'ตรวจสอบแล้ว' : 'กำลังดำเนินการ';
                const checked = isReviewed ? 'checked' : '';
                const evidenceList = Array.isArray(report.evidence) ? report.evidence : [];

                const reportCard = `
                    <div class="card rounded-xl p-4 border break-inside-avoid">
                        <div class="flex justify-between items-start">
                             <div>
                                <h3 class="font-bold text-lg">${report.rank} ${report.firstName} ${report.lastName}</h3>
                                <p class="text-sm text-gray-600">${report.unit} / ${report.position}</p>
                            </div>
                            <div class="flex gap-2 items-center no-print">
                                <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full ${statusClass}">${statusText}</span>
                                <button class="p-1 hover:bg-gray-200 rounded-full timeline-btn" data-id="${report.id}" title="ดูไทม์ไลน์"><i data-lucide="git-commit-horizontal"></i></button>
                            </div>
                        </div>
                        <div class="my-3 border-t pt-3 space-y-2 text-sm">
                             <p><strong>ประเภท:</strong> ${report.offenseType}</p>
                             <p><strong>วันที่เกิดเหตุ:</strong> ${new Date(report.startDate).toLocaleDateString('th-TH')}</p>
                             <p><strong>รายละเอียด:</strong> ${report.details}</p>
                             <p><strong>วันที่รายงาน:</strong> ${new Date(report.createdAt).toLocaleString('th-TH')}</p>
                        </div>
                        <div id="countdown-${report.id}" class="countdown p-2 rounded-lg text-center font-mono text-base" data-due-date="${report.dueDate}"></div>
                        <div class="mt-3">
                            <h4 class="font-semibold text-sm mb-1">หลักฐาน:</h4>
                            <div class="flex flex-wrap gap-2">
                                ${evidenceList.map(url => `<a href="${url}" target="_blank" rel="noopener noreferrer"><img src="${url.replace("open?id=", "uc?id=")}" class="thumbnail-img w-16 h-16 object-cover rounded-lg cursor-pointer border hover:opacity-75"></a>`).join('') || '<p class="text-xs text-gray-500">ไม่มีหลักฐานแนบ</p>'}
                            </div>
                        </div>
                        <div class="mt-4 border-t pt-4 space-y-2 no-print" data-role="reviewer admin">
                            <h4 class="font-semibold text-purple-800">สำหรับผู้ตรวจสอบ</h4>
                            <textarea class="form-input w-full p-2 border rounded-lg review-notes" data-id="${report.id}" placeholder="เพิ่มความคิดเห็น...">${report.reviewNotes || ''}</textarea>
                            <div class="flex items-center justify-between">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" class="rounded review-checkbox" data-id="${report.id}" ${checked}>
                                    <span>ตรวจสอบแล้ว</span>
                                </label>
                                <button class="bg-purple-700 hover:bg-yellow-500 text-white text-sm px-3 py-1.5 rounded-lg save-review-btn" data-id="${report.id}">บันทึกผล</button>
                            </div>
                        </div>
                         <div class="mt-4 border-t pt-4 flex gap-2 no-print" data-role="admin">
                            <button class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm px-3 py-1 rounded-lg flex items-center edit-btn" data-id="${report.id}"><i data-lucide="edit" class="h-4 w-4 mr-1"></i>แก้ไข</button>
                            <button class="bg-red-100 hover:bg-red-200 text-red-800 text-sm px-3 py-1 rounded-lg flex items-center delete-btn" data-id="${report.id}"><i data-lucide="trash-2" class="h-4 w-4 mr-1"></i>ลบ</button>
                         </div>
                    </div>
                `;
                $('#reportList').append(reportCard);
            });
            lucide.createIcons();
            updateCountdowns();
            applyRolePermissions(currentUser.role); // Re-apply permissions for dynamic content
        }
        
        // --- EVENT HANDLERS ---
        
        $('#disciplineForm').on('submit', async function(e) {
            e.preventDefault();
            Swal.fire({ title: 'กำลังบันทึกข้อมูล...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
            const caseId = $('#caseId').val();
            let action = caseId ? 'UPDATE' : 'CREATE';
            
            let reportData = {
                rank: $('#rank').val(), firstName: $('#firstName').val(), lastName: $('#lastName').val(),
                unit: $('#unit').val(), position: $('#position').val(), startDate: $('#startDate').val(),
                offenseType: $('#offenseType').val(), reviewDuration: $('#reviewDuration').val(),
                dueDate: $('#dueDate').val(), details: $('#details').val(),
            };

            if (action === 'CREATE') {
                reportData.id = Date.now().toString();
                reportData.createdAt = new Date().toISOString();
                reportData.reviewed = false;
                reportData.reviewNotes = "";
                reportData.timeline = []; // Initialize timeline
                reportData.evidence = fileDataUrls; // Attach base64 data for upload
            } else {
                const existingReport = localReportsCache.find(r => r.id == caseId);
                reportData = { ...existingReport, ...reportData };
                // Note: Evidence update not supported in this version via form
            }

            try {
                await apiCall(action, reportData);
                await fetchReports(); // Re-fetch data from server
                Swal.fire({ icon: 'success', title: 'บันทึกเรียบร้อย!', showConfirmButton: false, timer: 1500 });
                $('#disciplineForm')[0].reset();
                $('#file-preview-container').empty();
                $('#caseId').val('');
                $('#saveBtnText').text('บันทึกความผิด');
                fileDataUrls = [];
            } catch (error) { 
                Swal.fire('เกิดข้อผิดพลาด', `ไม่สามารถบันทึกข้อมูลได้: ${error.message}`, 'error');
            }
        });

        $('#reportList').on('click', '.delete-btn', function() {
            const id = $(this).data('id');
            Swal.fire({
                title: 'ต้องการลบรายการนี้?', text: "ข้อมูลจะถูกลบออกจาก Google Sheet!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'กำลังลบ...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
                    try {
                        await apiCall('DELETE', { id: id });
                        await fetchReports();
                        Swal.fire('ลบแล้ว!', 'รายการถูกลบเรียบร้อย', 'success');
                    } catch (error) { 
                        Swal.fire('เกิดข้อผิดพลาด', `ไม่สามารถลบข้อมูลได้: ${error.message}`, 'error'); 
                    }
                }
            })
        });

        $('#reportList').on('click', '.save-review-btn', async function() {
            const id = $(this).data('id');
            const notes = $(`.review-notes[data-id="${id}"]`).val();
            const isChecked = $(`.review-checkbox[data-id="${id}"]`).is(':checked');
            let report = localReportsCache.find(r => r.id == id);
            
            if (!report) return;

            report.reviewed = isChecked;
            report.reviewNotes = notes;
            if (isChecked && !report.reviewedAt) {
                report.reviewedAt = new Date().toISOString();
                if(!Array.isArray(report.timeline)) report.timeline = [];
                report.timeline.push({ status: 'Reviewed', timestamp: report.reviewedAt, notes: notes });
            }
            
            Swal.fire({ title: 'กำลังอัปเดตสถานะ...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });
            try {
                await apiCall('UPDATE', report);
                await fetchReports();
                Swal.fire('สำเร็จ', 'บันทึกผลการตรวจสอบแล้ว', 'success');
            } catch (error) { 
                Swal.fire('เกิดข้อผิดพลาด', `ไม่สามารถอัปเดตสถานะได้: ${error.message}`, 'error');
            }
        });
        
        $('#exportExcelBtn').on('click', function() {
            if (localReportsCache.length === 0) {
                Swal.fire('ไม่มีข้อมูล', 'ไม่มีข้อมูลสำหรับ Export', 'info');
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(localReportsCache);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Reports");
            XLSX.writeFile(workbook, "MilitaryDisciplineReports.xlsx");
        });

        // Other handlers (edit, clear, filter, modals, etc. remain largely the same)
        function updateCountdowns() {
            $('.countdown').each(function() {
                const elementId = $(this).attr('id');
                const dueDate = new Date($(this).data('due-date')).getTime();
                const interval = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = dueDate - now;
                    if (distance < 0) {
                        clearInterval(interval);
                        $(`#${elementId}`).html("ครบกำหนดแล้ว").addClass('bg-red-200 text-red-800');
                        return;
                    }
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    $(`#${elementId}`).html(`เหลือเวลา: ${days}d ${hours}h ${minutes}m ${seconds}s`);
                    if (distance < (3 * 24 * 60 * 60 * 1000)) {
                        $(`#${elementId}`).removeClass('bg-green-100').addClass('bg-yellow-200 text-yellow-800');
                    } else { $(`#${elementId}`).addClass('bg-green-100 text-green-800'); }
                }, 1000);
            });
        }
        $('#startDate, #reviewDuration').on('change', function() {
            const startDate = $('#startDate').val();
            const duration = parseInt($('#reviewDuration').val());
            if (startDate && !isNaN(duration)) {
                let date = new Date(startDate);
                date.setDate(date.getDate() + duration);
                $('#dueDate').val(date.toISOString().split('T')[0]);
            }
        });
        $('#clearBtn').on('click', function() {
            $('#disciplineForm')[0].reset();
            $('#file-preview-container').empty();
            $('#caseId').val('');
            $('#saveBtnText').text('บันทึกความผิด');
            fileDataUrls = [];
        });
        $('#filter-buttons').on('click', '.filter-btn', function() {
            const filter = $(this).data('filter');
            $('.filter-btn').removeClass('bg-purple-800 text-white').addClass('bg-gray-200 text-gray-800');
            $(this).removeClass('bg-gray-200 text-gray-800').addClass('bg-purple-800 text-white');
            renderReports(filter);
        });
        $('.filter-btn[data-filter="all"]').removeClass('bg-gray-200 text-gray-800').addClass('bg-purple-800 text-white');
        $('#printPdfBtn').on('click', function() { window.print(); });
        $('#reportList').on('click', '.thumbnail-img', function(e) { 
            e.preventDefault();
            const src = $(this).closest('a').attr('href');
            $('#modalImage').attr('src', src);
            $('#imageModal').removeClass('hidden');
        });
        $('#closeModal').on('click', () => $('#imageModal').addClass('hidden'));
        $('#reportList').on('click', '.timeline-btn', function() {
            const id = $(this).data('id');
            const report = localReportsCache.find(r => r.id == id);
            const timelineEvents = Array.isArray(report.timeline) ? report.timeline : [];
            let content = '';
            timelineEvents.forEach(event => {
                content += `<div class="flex items-start"><div class="w-8 h-8 rounded-full ${event.status === 'Created' ? 'bg-green-500' : 'bg-blue-500'} text-white flex items-center justify-center mr-4 flex-shrink-0"><i data-lucide="${event.status === 'Created' ? 'flag' : 'check'}"></i></div><div><p class="font-semibold">${event.status}</p><p class="text-sm text-gray-500">${new Date(event.timestamp).toLocaleString('th-TH')}</p>${event.notes ? `<p class="text-sm text-gray-600 mt-1 italic">"${event.notes}"</p>` : ''}</div></div>`;
            });
            $('#timelineContent').html(content || '<p>ยังไม่มีไทม์ไลน์</p>');
            lucide.createIcons();
            $('#timelineModal').removeClass('hidden');
        });
        $('#closeTimelineModal').on('click', () => $('#timelineModal').addClass('hidden'));
         $('#evidenceFiles').on('change', function(e) {
            $('#file-preview-container').empty();
            fileDataUrls = [];
            const files = Array.from(e.target.files);
            const promises = files.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = event => {
                        fileDataUrls.push(event.target.result);
                        $('#file-preview-container').append(`<img src="${event.target.result}" class="w-20 h-20 object-cover rounded-lg border">`);
                        resolve();
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            });
            Promise.all(promises);
        });
        $('#reportList').on('click', '.edit-btn', function() {
            const id = $(this).data('id');
            const report = localReportsCache.find(r => r.id == id);
            $('#caseId').val(report.id);
            $('#rank').val(report.rank);
            $('#firstName').val(report.firstName);
            $('#lastName').val(report.lastName);
            $('#unit').val(report.unit);
            $('#position').val(report.position);
            $('#startDate').val(report.startDate);
            $('#offenseType').val(report.offenseType);
            $('#reviewDuration').val(report.reviewDuration).trigger('change');
            $('#details').val(report.details);
            $('#file-preview-container').html('<p class="text-xs text-gray-500">การแก้ไขไฟล์หลักฐานยังไม่รองรับในเวอร์ชันนี้</p>');
            fileDataUrls = [];
            $('#saveBtnText').text('อัปเดตข้อมูล');
            $('html, body').animate({ scrollTop: 0 }, 'slow');
        });

        // Initializer
        checkLoginState();
    });
    </script>
</body>
</html>
